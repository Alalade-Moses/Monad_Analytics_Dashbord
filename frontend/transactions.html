 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions - Monad Analytics</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="/assets/monad-favicon.ico" type="image/x-icon">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">
                <div class="logo-icon">M</div>
                Monad Analytics
            </a>
            <button class="mobile-menu-toggle">â˜°</button>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/transactions" class="active">Transactions</a></li>
                <li><a href="/validators">Validators</a></li>
                <li><a href="/dapps">dApps</a></li>
                <li><a href="/network">Network</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="mb-3">
                <h1>Recent Transactions</h1>
                <p class="text-muted">Latest transactions on the Monad network</p>
            </div>

            <!-- Transaction Stats -->
            <section class="metrics-grid fade-in-up">
                <div class="metric-card">
                    <div class="metric-value" id="total-transactions">--</div>
                    <div class="metric-label">Total Transactions</div>
                    <div class="metric-change positive">+12.5% today</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successful-rate">--</div>
                    <div class="metric-label">Success Rate</div>
                    <div class="metric-change positive">99.8%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-gas-used">--</div>
                    <div class="metric-label">Avg Gas Used</div>
                    <div class="metric-change">Per transaction</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-tx-fee">--</div>
                    <div class="metric-label">Avg Transaction Fee</div>
                    <div class="metric-change">MON</div>
                </div>
            </section>

            <!-- Search and Filters -->
            <div class="card fade-in-up">
                <div class="card-header">
    <h3 class="card-title">PASTE YOUR WALLET ADDRESS HERE</h3>
    <button id="clearBtn" class="btn btn-secondary">Clear All</button>
</div>
<div class="card-content">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Search by Hash/Address</label>
            <input type="text" id="wallet-address" placeholder="Enter your wallet hash or address..." required

                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface-light); color: var(--text-primary);">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Status</label>
            <select id="status-filter" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface-light); color: var(--text-primary);">
                <option value="">All Statuses</option>
                <option value="success">Success</option>
                <option value="failed">Failed</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Transaction Type</label>
            <select id="type-filter" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface-light); color: var(--text-primary);">
                <option value="">All Types</option>
                <option value="transfer">Transfer</option>
                <option value="contract">Contract</option>
            </select>
        </div>
        <div style="display: flex; align-items: end;">
            <button id="searchBtn" class="btn btn-primary" style="width: 100%;">SEARCH FILTERS</button>
        </div>
    </div>
</div>

 <!-- Transactions Section -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title" id="table-title">Recent Transactions</h3>
    <div class="actions">
      <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
      <div class="status success">
        <div class="status-dot"></div>
        Auto-updating
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="table responsive-table">
      <thead>
        <tr>
          <th>Hash</th>
          <th>Block</th>
          <th>From</th>
          <th>To</th>
          <th>Value (MON)</th>
          <th>Fee</th>
          <th>Gas Used</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="transactions-table">
        <tr>
          <td colspan="9" class="loading">
            <div class="spinner"></div>
            Loading transactions...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


            <!-- Load More -->
             <button class="btn btn-secondary" id="load-more-btn" style="display: none;">
              Load More Transactions
              </button>


            <!-- Transaction Details Modal (Simple) -->
            <div id="transaction-modal" 
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; padding: 2rem;">
    <div class="transaction-content"
         style="max-width: 600px; margin: 0 auto; background: var(--surface); border-radius: 12px; padding: 2rem; max-height: 80vh; overflow-y: auto;">
         
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3>Transaction Details</h3>
            <button id="transaction-close" 
                    style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">
                &times;
            </button>
        </div>
        <div id="transaction-details"></div>
    </div>
</div>

    </main>

    <script src="/js/api.js"></script>
    <script>
        let allTransactions = [];
        let filteredTransactions = [];
        let displayedTransactions = [];
        let refreshInterval;
        let currentPage = 0;
        const pageSize = 20;
        let isWalletView = false;
        let currentWalletAddress = '';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadTransactions();
            setupAutoRefresh();
        });

        async function loadTransactions() {
            try {
                const transactions = await api.getTransactions(100); // Load more for filtering
                allTransactions = transactions || [];
                filteredTransactions = [...allTransactions];
                
                updateStats();
                displayTransactions();
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('Failed to load transactions');
            }
        }

         // In your loadWalletTransactions function, add logging:
async function loadWalletTransactions() {
    const walletAddress = document.getElementById('wallet-address').value.trim();
    
    if (!walletAddress) {
        alert('Please enter a wallet address');
        return;
    }
    
    try {
        console.log('Loading transactions for wallet:', walletAddress); // Debug log
        showLoading();
        currentWalletAddress = walletAddress;
        isWalletView = true;
        
        const transactions = await api.getTransactionsByAddress(walletAddress, 100);
        console.log('Received transactions:', transactions); // Debug log
        
        allTransactions = transactions || [];
        filteredTransactions = [...allTransactions];
        
        document.getElementById('table-title').textContent = `Transactions for ${api.formatHash(walletAddress, 8, 6)}`;
        updateStats();
        displayTransactions();
        
    } catch (error) {
        console.error('Error loading wallet transactions:', error);
        showError('Failed to load wallet transactions');
    }
}

        function updateStats() {
            if (allTransactions.length === 0) return;

            const successfulTxs = allTransactions.filter(tx => tx.status === 'success');
            const totalGasUsed = allTransactions.reduce((sum, tx) => sum + tx.gasUsed, 0);
            const totalFees = allTransactions.reduce((sum, tx) => sum + parseFloat(tx.fee), 0);

            document.getElementById('total-transactions').textContent = allTransactions.length.toLocaleString();
            document.getElementById('successful-rate').textContent = ((successfulTxs.length / allTransactions.length) * 100).toFixed(1) + '%';
            document.getElementById('avg-gas-used').textContent = Math.round(totalGasUsed / allTransactions.length).toLocaleString();
            document.getElementById('avg-tx-fee').textContent = (totalFees / allTransactions.length).toFixed(6);
        }

        function displayTransactions(reset = true) {
            if (reset) {
                currentPage = 0;
                displayedTransactions = [];
            }

            const startIndex = currentPage * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredTransactions.length);
            const newTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            displayedTransactions = displayedTransactions.concat(newTransactions);

            const tbody = document.getElementById('transactions-table');
            
            if (reset) {
                tbody.innerHTML = '';
            }

            if (newTransactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center">No transactions found</td></tr>`;
                return;
            }

            newTransactions.forEach(tx => {
                const row = createTransactionRow(tx);
                tbody.appendChild(row);
            });

            // Show/hide load more button
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (endIndex < filteredTransactions.length) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }

            currentPage++;
        }

        function createTransactionRow(tx) {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onclick = () => showTransactionDetails(tx);
            
            row.innerHTML = `
                <td>
                    <span style="font-family: monospace; font-size: 0.875rem;">${api.formatHash(tx.hash, 8, 6)}</span>
                </td>
                <td>${tx.blockNumber?.toLocaleString()}</td>
                <td>
                    <span style="font-family: monospace; font-size: 0.875rem;">${api.formatHash(tx.from, 6, 4)}</span>
                </td>
                <td>
                    <span style="font-family: monospace; font-size: 0.875rem;">${api.formatHash(tx.to, 6, 4)}</span>
                </td>
                <td>${parseFloat(tx.value).toFixed(4)}</td>
                <td>${parseFloat(tx.fee).toFixed(6)}</td>
                <td>${tx.gasUsed?.toLocaleString()}</td>
                <td>
                    <span class="status ${tx.status === 'success' ? 'success' : 'error'}">
                        <div class="status-dot"></div>
                        ${tx.status}
                    </span>
                </td>
                <td>${api.formatTimestamp(tx.timestamp)}</td>
            `;
            
            return row;
        }

        function showTransactionDetails(tx) {
            const modal = document.getElementById('transaction-modal');
            const details = document.getElementById('transaction-details');
            
            details.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <strong>Hash:</strong>
                        <div style="font-family: monospace; background: var(--surface-light); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; word-break: break-all;">
                            ${tx.hash}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Block Number:</strong>
                            <div>${tx.blockNumber?.toLocaleString()}</div>
                        </div>
                        <div>
                            <strong>Status:</strong>
                            <span class="status ${tx.status === 'success' ? 'success' : 'error'}">
                                <div class="status-dot"></div>
                                ${tx.status}
                            </span>
                        </div>
                    </div>
                    <div>
                        <strong>From:</strong>
                        <div style="font-family: monospace; background: var(--surface-light); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; word-break: break-all;">
                            ${tx.from}
                        </div>
                    </div>
                    <div>
                        <strong>To:</strong>
                        <div style="font-family: monospace; background: var(--surface-light); padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; word-break: break-all;">
                            ${tx.to}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Value:</strong>
                            <div>${parseFloat(tx.value).toFixed(6)} MON</div>
                        </div>
                        <div>
                            <strong>Transaction Fee:</strong>
                            <div>${parseFloat(tx.fee).toFixed(6)} MON</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Gas Used:</strong>
                            <div>${tx.gasUsed?.toLocaleString()}</div>
                        </div>
                        <div>
                            <strong>Gas Price:</strong>
                            <div>${tx.gasPrice} gwei</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Type:</strong>
                            <div style="text-transform: capitalize;">${tx.type}</div>
                        </div>
                        <div>
                            <strong>Timestamp:</strong>
                            <div>${new Date(tx.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeTransactionModal() {
            document.getElementById('transaction-modal').style.display = 'none';
        }

         
         // Replace the current applyFilters function with this:
function applyFilters() {
    const statusFilter = document.getElementById('status-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const searchValue = document.getElementById('wallet-address').value.trim().toLowerCase();

    // If there's a search value, it's a wallet address search
    if (searchValue && searchValue.length > 0) {
        if (searchValue.length < 20) {
            alert('Please enter a valid wallet address');
            return;
        }
        loadWalletTransactions();
        return;
    }

    // Otherwise, apply filters to existing transactions
    filteredTransactions = allTransactions.filter(tx => {
        const matchesStatus = !statusFilter || tx.status === statusFilter;
        const matchesType = !typeFilter || tx.type === typeFilter;
        return matchesStatus && matchesType;
    });

    document.getElementById('table-title').textContent = 'Recent Transactions';
    isWalletView = false;
    currentWalletAddress = '';
    displayTransactions(true);
}

// Update the search button event listener:
document.addEventListener("DOMContentLoaded", () => {
    // Button bindings
    document.getElementById("clearBtn").addEventListener("click", clearFilters);
    document.getElementById("searchBtn").addEventListener("click", applyFilters);
    document.getElementById("refreshBtn").addEventListener("click", refreshTransactions);
    
    // Add Enter key support for search
    document.getElementById("wallet-address").addEventListener("keypress", (e) => {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
});
         function clearFilters() {
    document.getElementById('wallet-address').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('type-filter').value = '';

    isWalletView = false;
    currentWalletAddress = '';
    document.getElementById('table-title').textContent = 'Recent Transactions';

    loadTransactions(); // reload full list
}

        // function loadMoreTransactions

        document.addEventListener("DOMContentLoaded", () => {
  // Button bindings (CSP-safe)
  const clearBtn = document.getElementById("clearBtn");
  const searchBtn = document.getElementById("searchBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const loadMoreBtn = document.getElementById("load-more-btn");

  if (clearBtn) clearBtn.addEventListener("click", clearFilters);
  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      const walletAddress = document.getElementById("wallet-address").value.trim();
      if (walletAddress) {
        loadWalletTransactions();
      } else {
        applyFilters();
      }
    });
  }
  if (refreshBtn) refreshBtn.addEventListener("click", refreshTransactions);

  // Attach load more handler (no inline onclick)
  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", (e) => {
      e.preventDefault();
      loadMoreTransactions();
    });
  } else {
    console.warn('load-more-btn not found in DOM.');
  }

  // other initializations if any
});


        function setupAutoRefresh() {
            refreshInterval = setInterval(async () => {
                if (isWalletView && currentWalletAddress) {
                    // For wallet view, we might not want to auto-refresh as frequently
                    // since it's a specific query
                    return;
                }
                
                const newTransactions = await api.getTransactions(20);
                if (newTransactions && newTransactions.length > 0) {
                    // Add new transactions to the beginning
                    const newHashes = newTransactions.map(tx => tx.hash);
                    const existingHashes = allTransactions.map(tx => tx.hash);
                    const trulyNewTransactions = newTransactions.filter(tx => !existingHashes.includes(tx.hash));
                    
                    if (trulyNewTransactions.length > 0) {
                        allTransactions = [...trulyNewTransactions, ...allTransactions];
                        applyFilters();
                        updateStats();
                    }
                }
            }, 10000); // Refresh every 10 seconds
        }

        function showLoading() {
            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = `<tr><td colspan="9" class="loading"><div class="spinner"></div>Loading transactions...</td></tr>`;
        }

        function showError(message) {
            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = `<tr><td colspan="9" class="error-message">${message}</td></tr>`;
        }

        // Mobile menu toggle
        document.querySelector('.mobile-menu-toggle').addEventListener('click', () => {
            document.querySelector('.nav-links').classList.toggle('active');
        });

        // Close modal on outside click
        document.getElementById('transaction-modal').addEventListener('click', (e) => {
            if (e.target.id === 'transaction-modal') {
                closeTransactionModal();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });



        document.addEventListener("DOMContentLoaded", () => {
    // Button bindings
    document.getElementById("clearBtn").addEventListener("click", clearFilters);
    document.getElementById("searchBtn").addEventListener("click", applyFilters);
    document.getElementById("refreshBtn").addEventListener("click", refreshTransactions);
});

document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("transaction-modal");
    const modalContent = modal.querySelector(".transaction-content");
    const closeBtn = document.getElementById("transaction-close");

    // Close when clicking backdrop
    modal.addEventListener("click", (e) => {
        if (e.target === modal) {
            closeTransactionModal();
        }
    });

    // Prevent closing when clicking inside modal content
    modalContent.addEventListener("click", (e) => {
        e.stopPropagation();
    });

    // Close when clicking X button
    closeBtn.addEventListener("click", () => {
        closeTransactionModal();
    });
});

function openTransactionModal(tx) {
    const modal = document.getElementById("transaction-modal");
    document.getElementById("transaction-details").innerHTML = JSON.stringify(tx, null, 2);
    modal.style.display = "block";
}

function closeTransactionModal() {
    const modal = document.getElementById("transaction-modal");
    modal.style.display = "none";
}




function renderTransactionRow(tx) {
  return `
    <tr>
      <td data-label="Hash">${tx.hash}</td>
      <td data-label="Block">${tx.blockNumber}</td>
      <td data-label="From">${tx.from}</td>
      <td data-label="To">${tx.to}</td>
      <td data-label="Value (MON)">${tx.value}</td>
      <td data-label="Fee">${tx.fee}</td>
      <td data-label="Gas Used">${tx.gasUsed}</td>
      <td data-label="Status">${tx.status}</td>
      <td data-label="Time">${api.formatTimestamp(tx.timestamp)}</td>
    </tr>
  `;
}


    </script>
</body>
</html>